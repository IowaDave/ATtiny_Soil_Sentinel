# Using the Internal Bandgap Voltage Reference
A peripheral built into the AVR chip can provide a stable voltage for comparison when operating on batteries.

## Battery Voltage Declines
Any kid who ever played with a flashlight (and every electric car driver) knows that battery power decreases over time. How well can an AVR microcontroller tolerate a decline in voltage when it is running on battery power?

Surprisingly well, for many purposes. For example, the ATtiny2313 chip used in this project can maintain its 8 MHz clock speed in a range from 5.5 volts down to 2.7 volts. Computations, timing-related operations, PWM, communications, digital I/O, detecting interrupts: these things can tolerate voltage decline within that range.

What about analog input? It depends on the choice of reference voltage. Battery voltage can be a poor choice. A better one is available.

<!-- the following produces a list of posts -->
{% include post_list.html %}

## How Analog Input Works
AVR microcontrollers assess "analog input" by comparing two voltage levels. Don't let the terminology bother you. They are a:

<ol type="a">
  <li> "negative" voltage that you wish to evaluate, and a</li>
  <li> "positive" reference voltage.</li>
</ol>

Most AVR chips support two ways to make the comparison: 
* Analog Comparator
* Analog to Digital Converter (ADC)

The ATtiny2313 used in this project offers only the Analog Comparator. It sets a bit in the hardware if the positive reference voltage is greater than the negative voltage being evaluated. It clears the bit if the negative voltage is the greater one.

ADC would be familiar to Arduino users as the ```analogRead()``` function. The ADC hardware performs a number of Analog Comparator assessments on a series of different reference voltages to obtain an integer result. The details are beyond the scope of this article. See the datasheet for your favorite AVR chip. 

The relevant point here is that the choice of reference voltage determines the result of both the Analog Comparator and the ADC hardware.

## How Battery Voltage Affects Analog Input
The main power supply to the chip, *Vcc*, is the default choice of reference voltage for analog comparison purposes. It should be obvious that battery voltage cannot supply a stable reference. 

I say, "It should be obvious..." Of course, silly me, I overlooked this effect in early prototypes of the Soil Sentinel. As a result of decreasing battery voltage, the Sentinel reported "dry soil" at progressively increasing levels of soil moisture.

Fortunately, AVR chips typically provide at least one alternative reference voltage: the "Internal Bandgap Reference Voltage", or <span style="font-style: italic;">V<sub>BG</sub></span>. This voltage is generated by a circuit built into the AVR chip. Typically it will be close to 1.1 volts, more or less, depending on the chip. The value will fluctuate very little, meaning, almost not at all.

## Choosing the Reference Voltage
Setting or clearing one or more bits in a hardware register determines which voltage reference to use for analog input. It is different for each model of AVR microcontroller. The datasheet for each model specifies the settings.

It's simple to choose for the ATtiny2313 used in this project. Setting a single bit, named "ACBG" (for Analog Comparator Band Gap, I suppose) directs the chip to use the internal bandgap voltage as the positive reference.

Now, all I have to do is to ensure that the voltage coming in for evaluation can be compared usefully to 1.1 volts.

## Divide the Sensor's Analog Output
The Capacitive Soil Moisture Sensor used in this project emits a voltage in the range of about 1.4 (in water) to about 2.8 volts (in dry air.) I learned this by measuring it with a multimeter. Totally dry potting soil reads about 2.3 volts. Reasonably wet soil gives about 1.7 volts. I reckoned that a plant might want watering at somewhere around 2.0 volts.

But wait. My reference voltage is only 1.1, more or less. I need to reduce the output of the sensor by about half, so that "wants water" equates to a voltage near 1.1. 

A 2 megaOhm potentiometer can serve as a convenient, adjustable voltage divider for this purpose. Feed the output of the sensor into the potentiometer. Evaluate the voltage emerging from the wiper. See the schematic, below.

![Schematic]({{site.baseurl}}images/schematic_Vbg.png)

Why such a large resistance value, 2 megaOhms, for the potentiometer? Because the current from the sensor is very small and potentiometers are resistors that drop voltage when current is held constant. For example, a 20 K&Omega; potentiometer cuts the sensor's measurable voltage output in half *before* the wiper further divides it. The 2 M&Omega; pot drops almost no voltage.

## Better than Battery
The internal bandgap reference voltage does not change enough to affect analog input, even as the battery voltage supplying the chip fades from 5 volts down to 3.3 volts or lower.

I believe that using <span>V<sub>BG</sub></span> as the voltage reference gives a more consistent "dry soil" indication from the Soil Sentinel.

## Playfulness
I learn this stuff on my own by a combination of reading and playful tinkering. It's important to stay in the playful space where it's fun when things don't work. I forget that sometimes and start calling myself stupid. 

The cure that works best is to set up an experiment that holds all things constant save one, then measure the effects of changing that one thing. In other words, play with the problem. I stumbled into recognizing the voltage drop due to the potentiometer by swapping a bunch of different pots into the circuit. Finally the light went on in my head. So soon old, so late aware. If I had studied electronics in school I might have known that sooner.

Oh well, Old Age = Second Childhood and now I get to catch up on all that playfulness the teacher made me stop when I was young. It's not a bad way to learn. Sticks with you, too.
