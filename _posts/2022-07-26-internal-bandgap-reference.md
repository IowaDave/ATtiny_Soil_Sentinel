# Using the Internal Bandgap Voltage Reference
A peripheral built into the AVR chip can provide a stable voltage for comparison when operating on batteries.

### Battery Voltage Declines
Any kid who ever played with a flashlight (and every electric car driver) knows that battery power decreases over time. How well can an AVR microcontroller tolerate a decline in voltage when it is running on battery power?

Surprisingly well, for many purposes. For example, the ATtiny2313 chip used in this project can maintain its 8 MHz clock speed in a range from 5.5 volts down to 2.7 volts. Computations, timing-related operations, PWM, communications, digital I/O, detecting interrupts: these things can tolerate voltage decline within that range.

What about analog input? It depends on the choice of reference voltage. Battery voltage turns out to be a poor choice. A better reference is available.

<!-- the following produces a list of posts -->
{% include post_list.html %}

### How Analog Input Works
AVR microcontrollers assess "analog input" by comparing two voltage levels:

<ol type="a">
  <li> the "subject" voltage that you wish to evaluate, and</li>
  <li> a "reference" voltage that you can specify.</li>
</ol>

Most AVR chips support two ways to make the comparison: 
* Analog Comparator
* Analog to Digital Converter (ADC)

The ATtiny2313 used in this project offers only the Analog Comparator. It's really simple. Connect a pin named AIN0 to one voltage, and pin AIN1 to the other. The chip sets a bit in a hardware register if the voltage on AIN0 is greater than that on AIN1. It clears the bit if AIN1 presents the greater voltage.

ADC would be familiar to Arduino users as the ```analogRead()``` function. The ADC hardware obtains an integer value by performing a number of Analog Comparator assessments on a series of different voltages derived from the reference voltage. The details are beyond the scope of this article. See the datasheet for your favorite AVR chip. 

The relevant point here is that the choice of reference voltage determines the result of both the Analog Comparator and the ADC hardware.

### How Battery Voltage Affects Analog Input
Two ways: one is fairly obvious; the other is sneaky and took a while to figure out.

#### The obvious way
The main power supply to the chip, *Vcc*, is the default choice of reference voltage for analog comparison purposes. It should be obvious that battery voltage cannot supply a stable reference. 

I say, "It should be obvious..." Of course, silly me, I overlooked this effect in early prototypes of the Soil Sentinel. As a result of decreasing battery voltage, the Sentinel reported "dry soil" at progressively increasing levels of soil moisture.

Fortunately, AVR chips typically provide at least one alternative reference voltage: the "Internal Bandgap Reference Voltage", or *V<sub>BG</sub>*. This voltage is generated by a circuit built into the AVR chip. Typically it will be close to 1.1 volts, more or less, depending on the chip. The value for a given chip will fluctuate very little, almost not at all.

#### Choosing the Reference Voltage
Setting or clearing one or more bits in a hardware register determines which voltage reference to use for analog input. It is different for each model of AVR microcontroller. The datasheet for each model specifies the settings.

It's simple to choose for the ATtiny2313 used in this project. Setting a single bit, named "ACBG" (for Analog Comparator Band Gap, I suppose) directs the chip to use the internal bandgap voltage rather than the AIN0 pin. Then the voltage output of the sensor needs to come in on the AIN1 pin.

Now, all I have to do is to ensure that the voltage coming in for evaluation can be compared usefully to 1.1 volts. But wait. This is where the second, sneaky effect of battery voltage comes into play.

#### The sneaky way
The sensor needs a minimum of 3.3 volts on its *Vin* pin. What voltage actually reaches it? Hmm... As *Vcc* varies, so does the voltage emitted by a digital I/O pin. Early designs for the Sentinel took power directly from a digital pin to supply the *Vin* pin of the sensor. There is a slight voltagte drop across the Tiny2313 processor, so this voltage would be a bit less than *Vcc*. I exacerbated this effect by placing a current-limiting resistor between the digital pin and the sensor, dropping even more voltage. 

Powering the sensor through the digital pin allows battery voltage to affect analog input by altering the voltage *being read from the sensor*. This will affect analog input sensing even if the reference voltage holds constant. The sensor's *Vin* pin should get the full battery voltage, unimpeded. But I still want a way to turn the power on and off.

My solution to this issue was to supply battery voltage directly to the sensor, then control the sensor with a MOSFET. I used an "N-channel" transistor, an old-timey 2N7000. It works well enough in a prototype. I'm open to suggestions for a better choice of MOSFET.

### Divide the Sensor's Analog Output
The Capacitive Soil Moisture Sensor used in this project emits a voltage in the range of about 1.4 (in water) to about 2.8 volts (in dry air.) I learned this by measuring it with a multimeter. Totally dry potting soil reads about 2.3 volts. Reasonably wet soil gives about 1.7 volts. I reckoned that a plant might want watering at somewhere around 2.0 volts.

But wait. That entire range is greater than my selected reference of 1.1 volts. I need to reduce the output of the sensor by about half, so that "wants water" equates to a voltage near 1.1. 

A 2 megaOhm potentiometer can serve as a convenient, adjustable voltage divider for this purpose. Feed the output of the sensor into the potentiometer. Evaluate the voltage emerging from the wiper. It is labeled "R3" in the schematic, below.

![Schematic]({{site.baseurl}}/images/schematic_Vbg_mosfet.png)

Why such a large resistance value, 2 megaOhms, for the potentiometer? Because the current from the sensor is very small and potentiometers are resistors that drop voltage when current is held constant. For example, a 20 K&Omega; potentiometer cuts the sensor's measurable voltage output in half *before* the wiper further divides it. The 2 M&Omega; pot drops almost no voltage.

### What Does R2 Do?
Notice the 10K-Ohm resistor, labeled R2, between the pin PD4 of the ATtiny2313 and ground. What is it doing there? 

It pulls the MOSFET gate all the way to zero volts when the digital pin is set LOW. Might not be strictly necessary but does little harm. At a slight cost of lost current while the transistor is "on", I obtain a clean "off" condition the rest of the time.

### Better than Battery
The internal bandgap reference voltage affords a fairly constant level for comparison, even as the battery voltage supplying the chip fades from 5 volts down to 3.3 volts or lower.

I believe that using *V<sub>BG</sub>* as the voltage reference gives a more consistent "dry soil" indication from the Soil Sentinel.

### Playfulness
I learn this stuff on my own by a combination of reading and playful tinkering. It's important to stay in the playful space where it's fun when things don't work. I forget that sometimes and start calling myself stupid. 

The cure that works best is to set up an experiment that holds all things constant save one, then measure the effects of changing that one thing. In other words, play with the problem. I stumbled into recognizing the voltage drop due to the potentiometer by swapping a bunch of different pots into the circuit. Finally the light went on in my head. 

So soon old, so late aware. If I had studied electronics in school I might have remembered sooner about voltage drop across a potentiometer.

Oh well, Old Age = Second Childhood and now I get to catch up on all that playfulness the teacher made me stop when I was young. It's not a bad way to learn. Sticks with you, too.
